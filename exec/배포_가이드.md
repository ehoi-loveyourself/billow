# ë°°í¬ ê°€ì´ë“œ

BILLOW ë°°í¬ ê°€ì´ë“œì…ë‹ˆë‹¤.

## ëª©ì°¨

1. [EC2 ì„¤ì •](##-ğŸ–¥ï¸-EC2-ì„¤ì •)
2. [DockerFile](##-ğŸ¬-DockerFile)
3. [Nginx ì„¤ì •](##-âš™-Nginx-ì„¤ì •)
   <br>

## ğŸ–¥ï¸ EC2 ì„¤ì •

### **EC2 ì ‘ì†**

<div>
<img src="./assets/Ec2 ì„œë²„ ì—°ê²°.png" width="500px" alt="Ec2 ì„œë²„ ì—°ê²°" />
</div>
<div>
<img src="./assets/hostì…ë ¥.png" width="500px" alt="hostì…ë ¥" />
</div>
<div>
<img src="./assets/ìš°ë¶„íˆ¬ ë¡œê·¸ì¸.png" width="500px" alt="ìš°ë¶„íˆ¬ ë¡œê·¸ì¸" />
</div>
<br>

### **Docker ì„¤ì¹˜**

- íŒ¨í‚¤ì§€ ì„¤ì¹˜
  ```
  $ sudo apt update
  $ sudo apt-get install -y ca-certificates \
    curl \
        software-properties-common \
        apt-transport-https \
        gnupg \
        lsb-release
  ```
- gpg í‚¤ ë‹¤ìš´ë¡œë“œ
  ```
  $ sudo mkdir -p /etc/apt/keyrings
  $ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  $ echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
  ```
- Docker ì„¤ì¹˜

  ```
  $ sudo apt update
  $ sudo apt install docker-ce docker-ce-cli containerd.io docker-compose
  ```

### **ì  í‚¨ìŠ¤ ì„¤ì •**

- ì  í‚¨ìŠ¤ ì»¨í…Œì´ë„ˆ ìƒì„±

  - docker-compose.yml íŒŒì¼

  ```
  $ vim docker-compose.yml
  ```

  ```
  version: '3'

  services:
    jenkins:
      image: jenkins/jenkins:lts
      container_name: jenkins
      volumes:
          - /var/run/docker.sock:/var/run/docker.sock
          - /jenkins:/var/jenkins_home
      ports:
          - "9090:8080"
      privileged: true
      user: root
  ```

  - ì»¨í…Œì´ë„ˆ ìƒì„±

  ```
  $ sudo docker-compose up -d
  $ sudo docker ps
  ```

  - Administrator password í™•ì¸

  ```
  $ sudo docker logs jenkins
  ```

  - ì  í‚¨ìŠ¤ ì ‘ì†

    - http://ì„œë²„ì£¼ì†Œ:9090 ì ‘ì†
    - í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜

### **ì  í‚¨ìŠ¤ í”„ë¡œì íŠ¸ ìƒì„±**

- í”„ë¡œì íŠ¸ ìƒì„±
  <div>
  <img src="./assets/í”„ë¡œì íŠ¸ ìƒì„±.png" width="500px" alt="í”„ë¡œì íŠ¸ ìƒì„±" />
  </div>

- í”„ë¡œì íŠ¸ êµ¬ì„±
  <div>
  <img src="./assets/í”„ë¡œì íŠ¸ ìƒì„±.png" width="500px" alt="í”„ë¡œì íŠ¸ ìƒì„±" />
  </div>
- build branch ë“±ë¡
  <div>
  <img src="./assets/branch ë“±ë¡.png" width="500px" alt="branch ë“±ë¡" />
  </div>
- ë¹Œë“œ ìœ ë°œ
  <div>
  <img src="./assets/ë¹Œë“œ ìœ ë°œ.png" width="500px" alt="ë¹Œë“œ ìœ ë°œ" />
  </div>
- Secret Token ë°œê¸‰
  <div>
  <img src="./assets/ì‹œí¬ë¦¿ í† í° ë°œê¸‰.jpg" width="500px" alt="ì‹œí¬ë¦¿ í† í° ë°œê¸‰" />
  </div>
- Build Steps > Execute shell

  ```
  //ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì‚­ì œ
  docker image prune -a --force

  //ë„ì»¤ ì´ë¯¸ì§€ ì••ì¶•íŒŒì¼ì„ ì €ì¥í•  í´ë” ìƒì„±
  mkdir -p /var/jenkins_home/images_tar

  cd /var/jenkins_home/workspace/billow/backend/billow/
  //ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ
  docker build -t springboot .
  //ë„ì»¤ ì´ë¯¸ì§€ë¥¼ ì••ì¶•í•˜ì—¬ í´ë”ì— ì €ì¥
  docker save springboot > /var/jenkins_home/images_tar/springboot.tar

  cd /var/jenkins_home/workspace/billow/backend/djangoBack/
  //ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ
  docker build -t django .
  //ë„ì»¤ ì´ë¯¸ì§€ë¥¼ ì••ì¶•í•˜ì—¬ í´ë”ì— ì €ì¥
  docker save django > /var/jenkins_home/images_tar/django.tar

  cd /var/jenkins_home/workspace/billow/frontend/
  //ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ
  docker build -t vue .
  //ë„ì»¤ ì´ë¯¸ì§€ë¥¼ ì••ì¶•í•˜ì—¬ í´ë”ì— ì €ì¥
  docker save vue > /var/jenkins_home/images_tar/vue.tar

  ls /var/jenkins_home/images_tar

  //tarì„ ì••ì¶• í•´ì œí•˜ì—¬ docker ì´ë¯¸ì§€ë¡œ ë“±ë¡
  docker load < /var/jenkins_home/images_tar/vue.tar
  docker load < /var/jenkins_home/images_tar/springboot.tar
  docker load < /var/jenkins_home/images_tar/django.tar

  //ì»¨í…Œì´ë„ˆê°€ ë™ì‘ì¤‘ì´ë©´ stop
  if (docker ps | grep "vue"); then docker stop vue; fi
  if (docker ps | grep "springboot"); then docker stop springboot; fi
  if (docker ps | grep "django"); then docker stop django; fi

  //ì»¨í…Œì´ë„ˆ ìƒì„±í•˜ê¸° 80 í¬íŠ¸ë¡œ ì—°ê²°
  docker run -it -d --rm -p 8080:80 --name vue vue
  echo "Run vue"
  docker run -it -d --rm -p 8009:8009 --name springboot springboot
  echo "Run springboot"
  docker run -it -d --rm -p 8000:8000  --name django django
  echo "Run django"
  ```

### **GitLab WebHook**

- Settingâ†’ Webhook ì„¤ì •
  <div>
  <img src="./assets/WebHook.png" width="500px" alt="WebHook" />
  </div>

### **ì  í‚¨ìŠ¤ ì»¨í…Œì´ë„ˆ Docker ì„¤ì¹˜**

- Ec2 ì ‘ì† í›„

  ```
  $ sudo docker exec -it jenkins bash
  ```

- íŒ¨í‚¤ì§€ ì„¤ì¹˜

  ```
  $ apt update
  $ apt-get install -y ca-certificates \
     curl \
        software-properties-common \
        apt-transport-https \
        gnupg \
        lsb-release
  ```

- gpg í‚¤ ë‹¤ìš´ë¡œë“œ

  ```
  $ mkdir -p /etc/apt/keyrings
  $ curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg

  $ echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \
  $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  ```

- Docker ì„¤ì¹˜

  ```
  $ apt update
  $ apt install docker-ce docker-ce-cli containerd.io docker-compose
  ```

### **MySQL ì„¤ì •**

- EC2 ì„¤ì •

  ```
  $ docker exec -it Billow /bin/bash
  $ docker run --name Billow -e MYSQL_ROOT_PASSWORD=[root ë¹„ë°€ë²ˆí˜¸] -d -p 3306:3306 mysql:8.0.30

  // mysql ì ‘ì†
  $ mysql -u root -p

  // user ìƒì„± ë° ê¶Œí•œ ë¶€ì—¬
  mysql> create user 'B309'@'%' identified by 'B309Billow'

  mysql> grant all privileges on *.* to 'B309'@'%' with grant option;
  ```

- Workbench ì„¤ì •
  - ì‚¬ìš©ì ê³„ì • ìƒì„±
    <div>
    <img src="./assets/ê³„ì • ìƒì„±.png" width="500px" alt="ê³„ì • ìƒì„±" />
    </div>
  - Connection ìƒì„±
    <div>
    <img src="./assets/ì»¤ë„¥ì…˜ ìƒì„±.png" width="500px" alt="ì»¤ë„¥ì…˜ ìƒì„±" />
    </div>

## ğŸ¬ DockerFile

### **SpringBoot**

```
FROM openjdk:11 AS builder
COPY gradlew .
COPY gradle gradle
COPY build.gradle .
COPY settings.gradle .
COPY src src
RUN chmod =x ./gradlew
RUN ./gradlew bootJar

FROM openjdk:11
COPY --from=builder build/libs/billow-0.0.1-SNAPSHOT.jar billow.jar

EXPOSE 8009
CMD ["java","-jar","/billow.jar"]
```

### **Django**

```
FROM python:3.10.1
WORKDIR /var/jenkins_home/workspace/billow/backend/djangoBack
COPY requirements.txt ./

RUN pip install --upgrade pip
RUN pip install -r requirements.txt
COPY . .
EXPOSE 8000
CMD ["gunicorn", "djangoBack.wsgi", "--bind", "0.0.0.0:8000"]
```

### **Vue**

```
FROM node:lts-alpine as build-stage
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

FROM nginx:stable-alpine
RUN rm -rf /etc/nginx/conf.d/defalut.conf
COPY --from=build-stage /app/nginx/default.conf /etc/nginx/conf.d/default.conf

RUN rm -rf /usr/share/nginx/html/*
COPY --from=build-stage /app/dist /usr/share/nginx/html

EXPOSE 80
ENTRYPOINT ["nginx", "-g", "daemon off;"]
```

## âš™ Nginx ì„¤ì •

### **Nginx ì„¤ì¹˜**

```
$ sudo apt update
$ sudo apt install nginx
```

### **default.conf**

- /etc/nginx/sites-available ê²½ë¡œì—ì„œ default íŒŒì¼ ì—´ê¸°

```server {
        listen 80 default_server;
        listen [::]:80 default_server;

        server_name j7b309.p.ssafy.io;
        return 301 https://j7b309.p.ssafy.io$request_uri;
}

server {

        # SSL configuration
        listen 443 ssl;
        listen [::]:443;
        server_name j7b309.p.ssafy.io;

        ssl_certificate /etc/letsencrypt/live/j7b309.p.ssafy.io/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/j7b309.p.ssafy.io/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

				//vue ê²½ë¡œ
        location / {
                proxy_pass http://localhost:8080;
                proxy_redirect off;
                charset utf-8;

                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-NginX-Proxy true;
		}
		//springboot ê²½ë¡œ
		location /api {
                proxy_pass http://localhost:8009;
                proxy_redirect off;
                charset utf-8;

                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-NginX-Proxy true;
        }
		//django ê²½ë¡œ
		location /db {
                proxy_pass http://127.0.0.1:8000;
                proxy_redirect off;
                charset utf-8;

                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-NginX-Proxy true;
        }
}:
```

### **Vue Nginx ì„¤ì •**

- í”„ë¡œì íŠ¸ê²½ë¡œ/nginx/default.conf

```
server {
        client_max_body_size 500M;

        location / {
                root /usr/share/nginx/html;
                index index.html;
                try_files $uri $uri/ /index.html;
        }
}
```
