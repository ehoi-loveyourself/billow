# Î∞∞Ìè¨ Í∞ÄÏù¥Îìú

## Î™©Ï∞®

---

1. [EC2 ÏÑ§Ï†ï]()
2. [DockerFile]()
3. [Nginx ÏÑ§Ï†ï]()

## üñ•Ô∏è EC2 ÏÑ§Ï†ï

---

### **EC2 Ï†ëÏÜç**

### **Docker ÏÑ§Ïπò**

- Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò
  ```java
  sudo apt update
  sudo apt-get install -y ca-certificates \
    curl \
        software-properties-common \
        apt-transport-https \
        gnupg \
        lsb-release
  ```
- gpg ÌÇ§ Îã§Ïö¥Î°úÎìú
  ```sudo mkdir -p /etc/apt/keyrings
  curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
  ```
- Docker ÏÑ§Ïπò

  ```java
  sudo apt update
  sudo apt install docker-ce docker-ce-cli containerd.io docker-compose
  ```

### **Ï††ÌÇ®Ïä§ ÏÑ§Ï†ï**

- Ï††ÌÇ®Ïä§ Ïª®ÌÖåÏù¥ÎÑà ÏÉùÏÑ±

  - docker-compose.yml ÌååÏùº

  ```java
  vim docker-compose.yml
  ```

  ```java
  version: '3'

  services:
    jenkins:
      image: jenkins/jenkins:lts
      container_name: jenkins
      volumes:
          - /var/run/docker.sock:/var/run/docker.sock
          - /jenkins:/var/jenkins_home
      ports:
          - "9090:8080"
      privileged: true
      user: root
  ```

  - Ïª®ÌÖåÏù¥ÎÑà ÏÉùÏÑ±

  ```java
  sudo docker-compose up -d
  sudo docker ps
  ```

  - Administrator password ÌôïÏù∏

  ```java
  sudo docker logs jenkins
  ```

  - Ï††ÌÇ®Ïä§ Ï†ëÏÜç

    - http://ÏÑúÎ≤ÑÏ£ºÏÜå:9090 Ï†ëÏÜç
    - ÌîåÎü¨Í∑∏Ïù∏ ÏÑ§Ïπò

### **Ï††ÌÇ®Ïä§ ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ±**

    //ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÎäî Ïù¥ÎØ∏ÏßÄ ÏÇ≠Ï†ú
    docker image prune -a --force

    //ÎèÑÏª§ Ïù¥ÎØ∏ÏßÄ ÏïïÏ∂ïÌååÏùºÏùÑ Ï†ÄÏû•Ìï† Ìè¥Îçî ÏÉùÏÑ±
    mkdir -p /var/jenkins_home/images_tar

    cd /var/jenkins_home/workspace/billow/backend/billow/
    //ÎèÑÏª§ Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
    docker build -t springboot .
    //ÎèÑÏª§ Ïù¥ÎØ∏ÏßÄÎ•º ÏïïÏ∂ïÌïòÏó¨ Ìè¥ÎçîÏóê Ï†ÄÏû•
    docker save springboot > /var/jenkins_home/images_tar/springboot.tar

    cd /var/jenkins_home/workspace/billow/backend/djangoBack/
    //ÎèÑÏª§ Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
    docker build -t django .
    //ÎèÑÏª§ Ïù¥ÎØ∏ÏßÄÎ•º ÏïïÏ∂ïÌïòÏó¨ Ìè¥ÎçîÏóê Ï†ÄÏû•
    docker save django > /var/jenkins_home/images_tar/django.tar

    cd /var/jenkins_home/workspace/billow/frontend/
    //ÎèÑÏª§ Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
    docker build -t vue .
    //ÎèÑÏª§ Ïù¥ÎØ∏ÏßÄÎ•º ÏïïÏ∂ïÌïòÏó¨ Ìè¥ÎçîÏóê Ï†ÄÏû•
    docker save vue > /var/jenkins_home/images_tar/vue.tar

    ls /var/jenkins_home/images_tar

    //tarÏùÑ ÏïïÏ∂ï Ìï¥Ï†úÌïòÏó¨ docker Ïù¥ÎØ∏ÏßÄÎ°ú Îì±Î°ù
    docker load < /var/jenkins_home/images_tar/vue.tar
    docker load < /var/jenkins_home/images_tar/springboot.tar
    docker load < /var/jenkins_home/images_tar/django.tar

    //Ïª®ÌÖåÏù¥ÎÑàÍ∞Ä ÎèôÏûëÏ§ëÏù¥Î©¥ stop
    if (docker ps | grep "vue"); then docker stop vue; fi
    if (docker ps | grep "springboot"); then docker stop springboot; fi
    if (docker ps | grep "django"); then docker stop django; fi

    //Ïª®ÌÖåÏù¥ÎÑà ÏÉùÏÑ±ÌïòÍ∏∞ 80 Ìè¨Ìä∏Î°ú Ïó∞Í≤∞
    docker run -it -d --rm -p 8080:80 --name vue vue
    echo "Run vue"
    docker run -it -d --rm -p 8009:8009 --name springboot springboot
    echo "Run springboot"
    docker run -it -d --rm -p 8000:8000  --name django django
    echo "Run django"

### **GitLab WebHook**

- Setting‚Üí Webhook ÏÑ§Ï†ï

### **Ï††ÌÇ®Ïä§ Ïª®ÌÖåÏù¥ÎÑà Docker ÏÑ§Ïπò**

- Ec2 Ï†ëÏÜç ÌõÑ

  ```
  sudo docker exec -it jenkins bash
  ```

- Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò

  ```
  apt update
  apt-get install -y ca-certificates \
     curl \
        software-properties-common \
        apt-transport-https \
        gnupg \
        lsb-release
  ```

- gpg ÌÇ§ Îã§Ïö¥Î°úÎìú

  ```
  mkdir -p /etc/apt/keyrings
  curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg

  echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \
  $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  ```

- Docker ÏÑ§Ïπò

  ```
  apt update
  apt install docker-ce docker-ce-cli containerd.io docker-compose
  ```

### **MySQL ÏÑ§Ï†ï**

    docker exec -it Billow /bin/bash
    docker run --name Billow -e MYSQL_ROOT_PASSWORD=[root ÎπÑÎ∞ÄÎ≤àÌò∏] -d -p 3306:3306 mysql:8.0.30

    // mysql Ï†ëÏÜç
    mysql -u root -p

    // user ÏÉùÏÑ± Î∞è Í∂åÌïú Î∂ÄÏó¨
    create user 'B309'@'%' identified by 'B309Billow'

    grant all privileges on *.* to 'B309'@'%' with grant option;

## üñ•Ô∏è DockerFile

---

### **SpringBoot**

```
FROM openjdk:11 AS builder
COPY gradlew .
COPY gradle gradle
COPY build.gradle .
COPY settings.gradle .
COPY src src
RUN chmod =x ./gradlew
RUN ./gradlew bootJar

FROM openjdk:11
COPY --from=builder build/libs/billow-0.0.1-SNAPSHOT.jar billow.jar

EXPOSE 8009
CMD ["java","-jar","/billow.jar"]
```

### **Django**

```
FROM python:3.10.1
WORKDIR /var/jenkins_home/workspace/billow/backend/djangoBack
COPY requirements.txt ./

RUN pip install --upgrade pip
RUN pip install -r requirements.txt
COPY . .
EXPOSE 8000
CMD ["gunicorn", "djangoBack.wsgi", "--bind", "0.0.0.0:8000"]
```

### **Vue**

```
FROM node:lts-alpine as build-stage
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

FROM nginx:stable-alpine
RUN rm -rf /etc/nginx/conf.d/defalut.conf
COPY --from=build-stage /app/nginx/default.conf /etc/nginx/conf.d/default.conf

RUN rm -rf /usr/share/nginx/html/*
COPY --from=build-stage /app/dist /usr/share/nginx/html

EXPOSE 80
ENTRYPOINT ["nginx", "-g", "daemon off;"]
```

## üñ•Ô∏è Nginx ÏÑ§Ï†ï

---

### **Nginx ÏÑ§Ïπò**

```
$ sudo apt update
$ sudo apt install nginx
```

### **default.conf**

- /etc/nginx/sites-available Í≤ΩÎ°úÏóêÏÑú default ÌååÏùº Ïó¥Í∏∞

```server {
        listen 80 default_server;
        listen [::]:80 default_server;

        server_name j7b309.p.ssafy.io;
        return 301 https://j7b309.p.ssafy.io$request_uri;
}

server {

        # SSL configuration
        listen 443 ssl;
        listen [::]:443;
        server_name j7b309.p.ssafy.io;

        ssl_certificate /etc/letsencrypt/live/j7b309.p.ssafy.io/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/j7b309.p.ssafy.io/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

				//vue Í≤ΩÎ°ú
        location / {
#               root /var/www/html;
#               index index.nginx-debian.html;
#               try_files $uri $uri/ /index.html;

                proxy_pass http://localhost:8080;
                proxy_redirect off;
                charset utf-8;

                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-NginX-Proxy true;
		}
		//springboot Í≤ΩÎ°ú
		location /api {
                proxy_pass http://localhost:8009;
                proxy_redirect off;
                charset utf-8;

                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-NginX-Proxy true;
        }
		//django Í≤ΩÎ°ú
		location /db {
                proxy_pass http://127.0.0.1:8000;
                proxy_redirect off;
                charset utf-8;

                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-NginX-Proxy true;
        }
}:
```

### **Vue Nginx ÏÑ§Ï†ï**

- ÌîÑÎ°úÏ†ùÌä∏Í≤ΩÎ°ú/nginx/default.conf

```
server {
        client_max_body_size 500M;

        location / {
                root /usr/share/nginx/html;
                index index.html;
                try_files $uri $uri/ /index.html;
        }
}
```
